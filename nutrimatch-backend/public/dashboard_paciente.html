<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch ‚Äî Meu Plano</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="login-header">
  <div class="container">
    <nav>
      <a class="brand" href="dashboard_paciente.html">
        <img src="images/logo.png" alt="Logo NutriMatch">
      </a>
      <div class="nav-links">
        <a href="dashboard_paciente.html">Plano</a>
        <a href="detalhe_receita.html">Receitas</a>
        <a href="perfil.html">üë§</a>
        <a href="/logout">Sair</a>
      </div>
    </nav>
  </div>
</header>

<main>
  <div class="container">

    <div class="top-actions">
      <button type="button" class="btn outline btn-back" onclick="window.history.back()">‚Üê Voltar</button>
    </div>

    <!-- RESUMO -->
    <section class="card">
      <h2>Meu plano de hoje</h2>
      <p class="small">
        Selecione a receita que voc√™ consumiu e confirme a refei√ß√£o.
        Caso n√£o tenha os ingredientes, utilize <strong>Substituir</strong>.
      </p>
    </section>

    <!-- PLANO DO DIA -->
    <section class="grid grid-3" id="refeicoes-container"></section>

    <!-- DI√ÅRIO ALIMENTAR -->
    <section class="card" style="margin-top:2rem;">
      <h2>Di√°rio alimentar</h2>
      <p class="small">
        As refei√ß√µes confirmadas aparecem automaticamente ap√≥s a confirma√ß√£o.
      </p>

      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Refei√ß√£o</th>
            <th>Receita escolhida</th>
            <th>Status</th>
            <th>A√ß√µes</th>

          </tr>
        </thead>
        <tbody id="diario-body">
          <tr>
            <td colspan="4" class="small">Carregando di√°rio...</td>
          </tr>
        </tbody>
      </table>
    </section>

  </div>
</main>

<footer class="footer">
  <div class="container">¬© 2025 NutriMatch ‚Ä¢ Flexibilidade real no plano alimentar.</div>
</footer>

<script src="js/app.js"></script>

<script>
  const mealTypes = ['cafe', 'lanche-manha', 'almoco', 'lanche-tarde', 'jantar', 'ceia'];
  const mealNames = {
    cafe: 'Caf√© da manh√£',
    'lanche-manha': 'Lanche da manh√£',
    almoco: 'Almo√ßo',
    'lanche-tarde': 'Lanche da tarde',
    jantar: 'Jantar',
    ceia: 'Ceia (opcional)'
  };

  function formatarDataBR(iso) {
    const [y, m, d] = (iso || '').split('-');
    return y ? `${d}/${m}/${y}` : '-';
  }

  async function carregarPlano() {
    const container = document.getElementById('refeicoes-container');
    container.innerHTML = '<p>Carregando plano...</p>';

    try {
      const hoje = new Date().toISOString().slice(0, 10);
      const resp = await fetch(`/api/plano-atual`);

      if (!resp.ok) {
        container.innerHTML = '<p>Plano n√£o dispon√≠vel.</p>';
        return;
      }

      const plano = await resp.json();
      const mealsByType = {};

      plano.forEach(m => {
        if (!mealsByType[m.refeicao]) mealsByType[m.refeicao] = [];
        mealsByType[m.refeicao].push(m);
      });

      container.innerHTML = mealTypes.map(type => {
        const meals = mealsByType[type] || [];
        if (meals.length === 0) return '';

        const avgKcal = Math.round(
          meals.reduce((sum, m) => sum + m.kcal_meta, 0) / meals.length
        );

        const options = meals.map(m => `
          <label class="recipe-option">
            <input type="radio" name="ref_${type}" value="${m.id}">
            <div class="recipe">
              <strong>${m.receita_recomendada}</strong>
              <p class="small">${m.kcal_meta} kcal</p>
            </div>
          </label>
        `).join('');

        return `
          <div class="meal">
            <h3>${mealNames[type]} ‚Ä¢ ${avgKcal} kcal</h3>
            <form class="meal-form" data-refeicao="${type}">
              <div class="recipes">${options}</div>
              <div class="actions">
                <button type="submit" class="btn">Confirmar refei√ß√£o</button>
                <a class="btn outline" href="listagem_sugestoes.html?refeicao=${type}&kcal=${avgKcal}">Substituir</a>
              </div>
            </form>
          </div>
        `;
      }).join('') || '<p>Nenhuma refei√ß√£o cadastrada hoje.</p>';

    } catch (err) {
      console.error(err);
      container.innerHTML = '<p>Erro ao carregar plano.</p>';
    }
  }

  async function excluirEntradaDiario(id) {
  if (!confirm('Excluir esta entrada do di√°rio?')) return;

  try {
    const resp = await fetch(`/api/diario/${id}`, { method: 'DELETE' });


    if (resp.ok) {
      await carregarDiario();
    } else {
      const data = await resp.json().catch(() => ({}));
      alert(data.mensagem || `Erro ao excluir. Status ${resp.status}`);
    }
  } catch (err) {
    console.error(err);
    alert('Erro de comunica√ß√£o ao excluir.');
  }
}


  async function carregarDiario() {
    const tbody = document.getElementById('diario-body');
    const hoje = new Date().toISOString().slice(0, 10);

    try {
      const resp = await fetch(`/api/plano-atual`);

      if (!resp.ok) {
        tbody.innerHTML = '<tr><td colspan="4">Erro ao carregar di√°rio.</td></tr>';
        return;
      }

      const registros = await resp.json();
      if (!registros.length) {
        tbody.innerHTML = '<tr><td colspan="4">Nenhuma refei√ß√£o confirmada hoje.</td></tr>';
        return;
      }

      tbody.innerHTML = registros.map(r => `
        <tr>
          <td>${formatarDataBR(r.data)}</td>
          <td>${mealNames[r.refeicao] || r.refeicao}</td>
          <td>${r.receita_nome || '-'}</td>
          <td>Confirmada</td>
          <td>
            <button type="button" class="btn outline" onclick="excluirEntradaDiario(${r.id})">
              Excluir
            </button>
          </td>
        </tr>
      `).join('');

    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="4">Erro de comunica√ß√£o.</td></tr>';
    }
  }

  document.addEventListener('submit', async (e) => {
    if (!e.target.classList.contains('meal-form')) return;

    e.preventDefault();
    const form = e.target;
    const refeicao = form.dataset.refeicao;
    const selected = form.querySelector(`input[name="ref_${refeicao}"]:checked`);

    if (!selected) {
      alert('Selecione uma receita.');
      return;
    }

    const recipeBox = selected.nextElementSibling;
    const receitaNome = recipeBox.querySelector('strong').textContent;
    const kcal = parseInt(recipeBox.querySelector('.small').textContent);

    const hoje = new Date().toISOString().slice(0, 10);

    try {
      const resp = await fetch('/confirmar-refeicao', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          data: hoje,
          refeicao,
          receita_id: selected.value,
          receita_nome: receitaNome,
          kcal_consumidas: kcal,
          origem: 'plano'
        })
      });

      if (resp.ok) {
        alert('Refei√ß√£o confirmada!');
        await carregarDiario();
      } else {
        alert('Erro ao confirmar refei√ß√£o.');
      }
    } catch {
      alert('Erro de comunica√ß√£o.');
    }
  });

  document.addEventListener('DOMContentLoaded', async () => {
    await carregarPlano();
    await carregarDiario();
  });
</script>

</body>
</html>
