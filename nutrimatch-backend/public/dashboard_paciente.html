<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch ‚Äî Meu Plano</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="login-header">
    <div class="container">
      <nav>
        <a class="brand" href="dashboard_paciente.html">
          <img src="images/logo.png" alt="Logo NutriMatch">
        </a>
        <div class="nav-links">
          <a href="dashboard_paciente.html">Plano</a>
          <a href="detalhe_receita.html">Receitas</a>
          <a href="perfil.html">üë§</a>
          <!-- Sair aciona a rota de logout para encerrar a sess√£o -->
          <a href="/logout">Sair</a>
        </div>
      </nav>
    </div>
  </header>

  <main>
  <div class="container">

    <div class="top-actions">
      <button
        type="button"
        class="btn outline btn-back"
        onclick="window.history.back()"
      >
        ‚Üê Voltar
      </button>
    </div>

      <!-- RESUMO DO PLANO -->
      <section class="card">
        <h2>Meu plano de hoje</h2>
        <p class="small">
          Plano cadastrado pela nutricionista, com 3 op√ß√µes de receita por refei√ß√£o na mesma faixa de calorias.
          Selecione a op√ß√£o que voc√™ seguiu e confirme a refei√ß√£o. Caso n√£o tenha os ingredientes, use o bot√£o
          <strong>Substituir</strong> para buscar alternativas.
        </p>
      </section>

      <!-- REFEI√á√ïES DO DIA -->
      <section class="grid grid-3" id="refeicoes-container">
        <!-- Meals will be loaded dynamically -->
      </section>

      <!-- DI√ÅRIO ALIMENTAR (VIS√ÉO PARA NUTRICIONISTA) -->
      <section class="card" id="diario-alimentar" style="margin-top:2rem;">
        <h2>Di√°rio alimentar</h2>
        <p class="small">
          As refei√ß√µes confirmadas pelo paciente ao longo dos dias aparecem aqui para o nutricionista acompanhar
          a ades√£o ao plano alimentar.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Refei√ß√£o</th>
              <th>Receita escolhida</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- Exemplo est√°tico para o prot√≥tipo -->
            <tr>
              <td>10/12/2025</td>
              <td>Caf√© da manh√£</td>
              <td>Vitamina de banana</td>
              <td>Confirmada</td>
            </tr>
            <tr>
              <td>10/12/2025</td>
              <td>Almo√ßo</td>
              <td>Frango + arroz + salada</td>
              <td>Confirmada</td>
            </tr>
            <tr>
              <td>09/12/2025</td>
              <td>Lanche da tarde</td>
              <td>Panqueca de banana</td>
              <td>Confirmada</td>
            </tr>
          </tbody>
        </table>
      </section>

    </div>
  </main>

  <footer class="footer">
    <div class="container">¬© 2025 NutriMatch ‚Ä¢ Flexibilidade real no plano alimentar.</div>
  </footer>
  <!-- Script centralizado para funcionalidades din√¢micas (futuro) -->
  <script src="js/app.js"></script>

  <script>
    async function carregarPlano() {
      const container = document.getElementById('refeicoes-container');
      container.innerHTML = '<p>Carregando plano...</p>';

      try {
        const hoje = new Date().toISOString().slice(0, 10);
        const resp = await fetch(`/api/plano?data=${hoje}`);
        if (!resp.ok) {
          container.innerHTML = '<p>Plano n√£o dispon√≠vel. Entre em contato com sua nutricionista.</p>';
          return;
        }
        const plano = await resp.json();

        // Group by refeicao
        const mealsByType = {};
        plano.forEach(m => {
          if (!mealsByType[m.refeicao]) mealsByType[m.refeicao] = [];
          mealsByType[m.refeicao].push(m);
        });

        const mealTypes = ['cafe', 'lanche-manha', 'almoco', 'lanche-tarde', 'jantar', 'ceia'];
        const mealNames = {
          'cafe': 'Caf√© da manh√£',
          'lanche-manha': 'Lanche da manh√£',
          'almoco': 'Almo√ßo',
          'lanche-tarde': 'Lanche da tarde',
          'jantar': 'Jantar',
          'ceia': 'Ceia (opcional)'
        };

        container.innerHTML = mealTypes.map(type => {
          const meals = mealsByType[type] || [];
          if (meals.length === 0) return '';

          const totalKcal = meals.reduce((sum, m) => sum + m.kcal_meta, 0) / meals.length; // average
          const recipesHtml = meals.map(m => `
            <label class="recipe-option">
              <input type="radio" name="ref_${type}" value="${m.id}">
              <div class="recipe">
                <strong>${m.receita_recomendada}</strong>
                <p class="small">${m.kcal_meta} kcal</p>
              </div>
            </label>
          `).join('');

          return `
            <div class="meal">
              <h3>${mealNames[type]} ‚Ä¢ ${Math.round(totalKcal)} kcal</h3>
              <form class="meal-form" data-refeicao="${type}">
                <div class="recipes">${recipesHtml}</div>
                <div class="actions">
                  <button type="submit" class="btn">Confirmar refei√ß√£o</button>
                  <a class="btn outline" href="listagem_sugestoes.html">Substituir</a>
                </div>
              </form>
            </div>
          `;
        }).join('');

        if (container.innerHTML.trim() === '') {
          container.innerHTML = '<p>Nenhuma refei√ß√£o cadastrada para hoje.</p>';
        }
      } catch (err) {
        console.error(err);
        container.innerHTML = '<p>Erro ao carregar plano.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', carregarPlano);

    // Handle meal confirmation
    document.addEventListener('submit', async (e) => {
      if (e.target.classList.contains('meal-form')) {
        e.preventDefault();
        const form = e.target;
        const refeicao = form.dataset.refeicao;
        const selectedRadio = form.querySelector(`input[name="ref_${refeicao}"]:checked`);
        if (!selectedRadio) {
          alert('Selecione uma receita para confirmar.');
          return;
        }
        const receitaId = selectedRadio.value;
        const receitaNome = selectedRadio.nextElementSibling.querySelector('strong').textContent;
        const kcalText = selectedRadio.nextElementSibling.querySelector('.small').textContent;
        const kcal = parseInt(kcalText);

        const hoje = new Date().toISOString().slice(0, 10);

        try {
          const resp = await fetch('/confirmar-refeicao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              data: hoje,
              refeicao,
              receita_id: receitaId,
              receita_nome: receitaNome,
              kcal_consumidas: kcal,
              origem: 'plano'
            })
          });
          if (resp.ok) {
            alert('Refei√ß√£o confirmada e registrada no di√°rio!');
            // Optionally reload or update UI
          } else {
            alert('Erro ao confirmar refei√ß√£o.');
          }
        } catch (err) {
          alert('Erro de comunica√ß√£o.');
        }
      }
    });
  </script>
</body>
</html>
