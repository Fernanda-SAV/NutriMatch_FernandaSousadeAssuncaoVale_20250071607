<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch — Dashboard Nutricionista</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <a class="brand" href="dashboard_nutri.html">
          <img src="images/logo.png" alt="Logo NutriMatch">
          <strong>NutriMatch</strong>
        </a>
        <div class="nav-links">
          <a href="dashboard_nutri.html">Meus pacientes</a>
          <a href="paciente.html">Paciente</a>
          <a href="editar_pacientes.html">Editar pacientes</a>
          <a href="/logout">Sair</a>
        </div>
      </nav>
    </div>
  </header>

  <main>
  <div class="container">

    <div class="top-actions">
      <button
        type="button"
        class="btn outline btn-back"
        onclick="window.history.back()"
      >
        ← Voltar
      </button>
    </div>

      <!-- BLOCO NOVO: VINCULAR PACIENTE AO NUTRICIONISTA -->
      <section class="card" style="margin-bottom:1.5rem;">
        <h2>Vincular novo paciente</h2>
        <p class="small">
          Para acompanhar um paciente no NutriMatch, ele precisa ter uma conta cadastrada como
          <strong>paciente</strong>. Peça ao paciente o e-mail de acesso e use o campo abaixo para vinculá-lo
          à sua lista. Depois do vínculo, você poderá cadastrar o plano alimentar e registrar a evolução das
          medidas corporais a cada consulta.
        </p>

        <form id="form-vincular" class="form-vertical">
          <div class="campo">
            <label for="email_paciente">E-mail do paciente cadastrado no NutriMatch</label>
            <input
              id="email_paciente"
              name="email_paciente"
              type="email"
              placeholder="paciente@exemplo.com"
              required>
          </div>

          <button class="btn" type="submit">Vincular paciente</button>
        </form>

        <p class="small" style="margin-top:.6rem;">
          O sistema verifica se o e-mail existe, se pertence a um usuário do tipo paciente e,
          se estiver tudo certo, cria o vínculo entre você e o paciente na base de dados.
        </p>

      </section>

      <!-- LISTA DE PACIENTES JÁ VINCULADOS -->
      <section>
        <h2>Meus pacientes</h2>

        <div class="actions" style="margin-bottom:.8rem">
          <a class="btn outline" href="editar_pacientes.html">Editar pacientes</a>
        </div>

        <div id="meus-pacientes-msg" class="small"></div>
        <div id="meus-pacientes-grid" class="grid grid-2"></div>

      </section>


    </div>
  </main>

  <footer class="footer">
    <div class="container">© 2025 NutriMatch • Flexibilidade real no plano alimentar.</div>
  </footer>

<!--script src="js/app.js"></script>-->
<script>
  async function carregarPacientes() {
    const grid = document.getElementById('meus-pacientes-grid');
    const msg = document.getElementById('meus-pacientes-msg');

    msg.textContent = 'Carregando pacientes...';
    grid.innerHTML = '';

    try {
      const response = await fetch('/api/pacientes');
      const data = await response.json().catch(() => null);

      if (!response.ok) {
        msg.textContent = (data && data.mensagem) ? data.mensagem : 'Erro ao carregar pacientes.';
        return;
      }

      // ✅ funciona se a API retornar array direto ou { ok, pacientes }
      const pacientes = Array.isArray(data) ? data : (data && data.pacientes) ? data.pacientes : [];

      if (!pacientes.length) {
        msg.textContent = 'Nenhum paciente vinculado ainda.';
        return;
      }

      msg.textContent = '';

      grid.innerHTML = pacientes.map(p => `
        <div class="card">
          <h3>${p.nome || 'Paciente'}</h3>
          <p class="small">
            ${p.email ? `E-mail: ${p.email}<br>` : ''}
            ${p.meta_kcal_diaria != null ? `Meta diária: ${p.meta_kcal_diaria} kcal<br>` : ''}
            ${p.peso != null ? `Peso: ${p.peso} kg • ` : ''}${p.altura != null ? `Altura: ${p.altura} cm` : ''}
          </p>
          <div class="actions">
            <a class="btn" href="paciente.html">Ver plano</a>
          </div>
        </div>
      `).join('');

    } catch (err) {
      msg.textContent = 'Erro de conexão com o servidor.';
    }
  }

  async function vincularPaciente(event) {
    event.preventDefault();

    const form = event.currentTarget;
    const email_paciente = (form.email_paciente.value || '').trim().toLowerCase();

    if (!email_paciente) {
      alert('Informe o e-mail do paciente.');
      return;
    }

    try {
      const resp = await fetch('/vincular-paciente', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: new URLSearchParams({ email_paciente }).toString()
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        alert(data.mensagem || 'Erro ao vincular paciente.');
        return;
      }

      alert(data.mensagem || 'Paciente vinculado com sucesso!');
      form.reset();
      await carregarPacientes();

    } catch (e) {
      alert('Erro de comunicação com o servidor.');
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('form-vincular');
    if (form) form.addEventListener('submit', vincularPaciente);
  });

</script>





</body>
</html>

