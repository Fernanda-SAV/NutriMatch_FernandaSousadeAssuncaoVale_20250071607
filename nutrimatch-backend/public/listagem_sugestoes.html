<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch ‚Äî Refei√ß√µes</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="login-header">
    <div class="container">
      <nav>
        <a class="brand" href="dashboard_paciente.html">
          <img src="images/logo.png" alt="Logo NutriMatch">
        </a>
        <div class="nav-links">
          <a href="dashboard_paciente.html">Plano</a>
          <a href="detalhe_receita.html">Receitas</a>
          <a href="perfil.html">üë§</a>
          <a href="/logout">Sair</a>
        </div>
      </nav>
    </div>
  </header>

  <main>
  <div class="container">

    <div class="top-actions">
      <button type="button" class="btn outline btn-back" onclick="window.history.back()">‚Üê Voltar</button>
    </div>

    <!-- FILTRO -->
    <section class="card">
      <h2>Refei√ß√µes ‚Äî NutriMatch</h2>
      <p class="small" id="info-meta">Carregando...</p>

      <form class="inline" id="form-filtro" onsubmit="return false" style="margin-top:.75rem;">
        <select id="filtro-refeicao">
          <option value="cafe">Caf√© da manh√£</option>
          <option value="lanche-manha">Lanche da manh√£</option>
          <option value="almoco">Almo√ßo</option>
          <option value="lanche-tarde">Lanche da tarde</option>
          <option value="jantar">Jantar</option>
          <option value="ceia">Ceia</option>
        </select>

        <input id="filtro-meta" type="number" min="1" placeholder="Meta kcal" style="max-width:160px;">
        <input id="filtro-busca" placeholder="Buscar pelo nome (opcional)" style="min-width:220px;">

        <button type="button" class="btn outline" id="btn-aplicar">Aplicar</button>
      </form>
    </section>

    <!-- IA -->
    <section class="card" style="margin-top:1rem;">
      <h3>Gerar receita com IA ‚Äî Tenho em casa</h3>
      <p class="small">
        Informe ingredientes (separados por v√≠rgula). A receita ser√° gerada para a categoria/meta selecionadas e salva no NutriMatch.
      </p>

      <form class="inline" id="form-ia">
        <input id="ingredientes-ia" placeholder="Ex: banana, ovo, aveia">
        <button type="submit" class="btn outline">Gerar com IA</button>
      </form>

      <p class="small" id="ia-status" style="margin-top:.75rem;"></p>
    </section>

    <!-- LISTA √öNICA -->
    <section class="section-lista" style="margin-top:2rem;">
      <h3>Receitas dispon√≠veis</h3>
      <p class="small">
        Resultados da categoria/meta (¬±10%). Inclui receitas do banco e as geradas por IA.
      </p>

      <div class="grid grid-3" id="cards-receitas">
        <p class="small">Carregando receitas...</p>
      </div>
    </section>

  </div>
  </main>

  <footer class="footer">
    <div class="container">¬© 2025 NutriMatch ‚Ä¢ Flexibilidade real no plano alimentar.</div>
  </footer>

  <!-- Se seu js/app.js estiver quebrando a p√°gina, COMENTE a linha abaixo -->
  <script src="js/app.js"></script>

  <script>
    const mealNames = {
      cafe: 'Caf√© da manh√£',
      'lanche-manha': 'Lanche da manh√£',
      almoco: 'Almo√ßo',
      'lanche-tarde': 'Lanche da tarde',
      jantar: 'Jantar',
      ceia: 'Ceia (opcional)'
    };

    const state = { refeicao: 'cafe', meta: 200, busca: '' };

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function withinRange(kcal, meta, pct = 0.10) {
      const min = meta * (1 - pct);
      const max = meta * (1 + pct);
      return kcal >= min && kcal <= max;
    }

    function hojeISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function atualizarInfo() {
      document.getElementById('info-meta').textContent =
        `Categoria: ${mealNames[state.refeicao] || state.refeicao} ‚Ä¢ Meta: ${state.meta} kcal`;
    }

    function cardReceita(r) {
      const kcalNum = Number(r.kcal_total || 0);
      const kcalTxt = r.kcal_total != null ? `${Math.round(kcalNum)} kcal` : '-';

      const descFull = String(r.descricao || '');
      const desc = descFull.slice(0, 140);

      const tagOrigem = (r.origem || 'banco') === 'ia' ? 'IA' : 'NutriMatch';

      const detalheUrl =
        `detalhe_receita.html?id=${Number(r.id)}&refeicao=${encodeURIComponent(state.refeicao)}&kcal=${encodeURIComponent(state.meta)}`;

      return `
        <article class="card">
          <h4>${escapeHtml(r.nome || 'Receita')}</h4>
          <p class="small">
            <strong>Calorias:</strong> ${kcalTxt}<br>
            <strong>Origem:</strong> ${tagOrigem}<br>
            ${desc ? `<strong>Descri√ß√£o:</strong> ${escapeHtml(desc)}${descFull.length > 140 ? '...' : ''}` : ''}
          </p>
          <div class="actions">
            <button
              type="button"
              class="btn btn-usar"
              data-id="${Number(r.id)}"
              data-nome="${escapeHtml(r.nome || '')}"
              data-kcal="${kcalNum}"
              data-origem="${escapeHtml(r.origem || 'banco')}"
            >
              Usar esta
            </button>

            <a class="btn link" href="${detalheUrl}">Detalhes</a>
          </div>
        </article>
      `;
    }

    async function usarReceita(receitaId, receitaNome, kcal, origem) {
      try {
        const resp = await fetch('/confirmar-refeicao', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            data: hojeISO(),
            refeicao: state.refeicao,
            receita_id: receitaId,
            receita_nome: receitaNome,
            kcal_consumidas: kcal || state.meta,
            origem: origem || 'substituicao',
            observacao: 'Registro feito a partir da listagem_sugestoes'
          })
        });

        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          alert(data.mensagem || `Erro ao registrar. Status ${resp.status}`);
          return;
        }

        alert('Registrado no di√°rio!');
        window.location.href = 'dashboard_paciente.html';
      } catch (e) {
        console.error(e);
        alert('Erro de comunica√ß√£o.');
      }
    }

    async function carregarReceitas() {
      atualizarInfo();

      const cards = document.getElementById('cards-receitas');
      cards.innerHTML = `<p class="small">Carregando receitas...</p>`;

      try {
        const url = `/api/receitas?refeicao=${encodeURIComponent(state.refeicao)}&kcal=${encodeURIComponent(state.meta)}`;
        const resp = await fetch(url);

        if (!resp.ok) {
          cards.innerHTML = `<p class="small">Erro ao carregar receitas. Status ${resp.status}</p>`;
          return;
        }

        let receitas = await resp.json();

        receitas = (receitas || [])
          .filter(r => state.meta ? withinRange(Number(r.kcal_total || 0), state.meta, 0.10) : true)
          .filter(r => state.busca
            ? String(r.nome || '').toLowerCase().includes(state.busca.toLowerCase())
            : true
          );

        if (!receitas.length) {
          cards.innerHTML = `<p class="small">Nenhuma receita encontrada para esta categoria/meta.</p>`;
          return;
        }

        cards.innerHTML = receitas.slice(0, 18).map(cardReceita).join('');
      } catch (e) {
        console.error(e);
        cards.innerHTML = `<p class="small">Erro de comunica√ß√£o ao carregar receitas.</p>`;
      }
    }

    async function gerarComIA(e) {
      e.preventDefault();

      const status = document.getElementById('ia-status');
      const inp = document.getElementById('ingredientes-ia');
      const ingredientes = (inp.value || '').split(',').map(s => s.trim()).filter(Boolean);

      if (!ingredientes.length) return alert('Informe pelo menos 1 ingrediente.');

      status.textContent = 'Gerando receita com IA...';

      try {
        const resp = await fetch('/api/gerar-receita-ia', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ingredientes,
            kcal_meta: state.meta,
            refeicao: state.refeicao
          })
        });

        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          status.textContent = data.mensagem || `Erro IA. Status ${resp.status}`;
          return;
        }

        status.textContent = 'Receita gerada e salva no NutriMatch ‚úÖ';
        inp.value = '';

        await carregarReceitas();
      } catch (e) {
        console.error(e);
        status.textContent = 'Erro de comunica√ß√£o com a IA.';
      }
    }

    function initFromUrl() {
      const url = new URL(window.location.href);
      const r = url.searchParams.get('refeicao');
      const k = Number(url.searchParams.get('kcal') || 0);

      if (r) state.refeicao = r;
      if (k > 0) state.meta = k;

      document.getElementById('filtro-refeicao').value = state.refeicao;
      document.getElementById('filtro-meta').value = state.meta;
      atualizarInfo();
    }

    function aplicarFiltro() {
      const refeicao = document.getElementById('filtro-refeicao').value;
      const meta = Number(document.getElementById('filtro-meta').value || 0);
      const busca = document.getElementById('filtro-busca').value || '';

      if (!refeicao) return alert('Selecione a categoria.');
      if (!meta || meta <= 0) return alert('Informe meta kcal v√°lida.');

      state.refeicao = refeicao;
      state.meta = meta;
      state.busca = busca.trim();

      const url = new URL(window.location.href);
      url.searchParams.set('refeicao', state.refeicao);
      url.searchParams.set('kcal', String(state.meta));
      window.history.replaceState({}, '', url.toString());

      carregarReceitas();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initFromUrl();

      // ‚úÖ agora existe e √© chamada corretamente
      carregarReceitas();

      document.getElementById('btn-aplicar').addEventListener('click', aplicarFiltro);
      document.getElementById('form-ia').addEventListener('submit', gerarComIA);

      // ‚úÖ listener √∫nico para ‚ÄúUsar esta‚Äù (sem onclick com string)
      document.getElementById('cards-receitas').addEventListener('click', (ev) => {
        const btn = ev.target.closest('.btn-usar');
        if (!btn) return;

        const receitaId = Number(btn.dataset.id);
        const receitaNome = (btn.dataset.nome || '');
        const kcal = Number(btn.dataset.kcal || 0);
        const origem = btn.dataset.origem || 'banco';

        usarReceita(receitaId, receitaNome, kcal, origem);
      });
    });
  </script>
</body>
</html>
