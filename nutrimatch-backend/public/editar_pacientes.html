<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch ‚Äî Editar Pacientes</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="login-header">
    <div class="container">
      <nav>
        <a class="brand" href="dashboard_nutri.html">
          <img src="images/logo.png" alt="Logo NutriMatch">
        </a>
        <div class="nav-links">
          <a href="dashboard_nutri.html">Meus pacientes</a>
          <a href="perfil.html">üë§</a>
          <!-- Sair via rota de logout -->
          <a href="/logout">Sair</a>
        </div>
      </nav>
    </div>
  </header>

  <main>
  <div class="container">

    <div class="top-actions">
      <button
        type="button"
        class="btn outline btn-back"
        onclick="window.history.back()"
      >
        ‚Üê Voltar
      </button>
    </div>

      <!-- BUSCAR / FILTRAR PACIENTE -->
      <section class="card">
        <h2>Editar pacientes</h2>
        <p class="small">
          Use esta p√°gina para localizar pacientes vinculados e acessar a tela de gest√£o completa.
          Na gest√£o do paciente voc√™ poder√° editar dados cadastrais, meta cal√≥rica, plano alimentar
          e acompanhar o di√°rio alimentar.
        </p>

        <form class="inline" onsubmit="return false">
          <input placeholder="Buscar por nome ou e-mail do paciente">
          <a class="btn" href="#lista-pacientes">Buscar</a>
        </form>
      </section>

      <!-- LISTA DE PACIENTES VINCULADOS -->
      <section class="card" id="lista-pacientes" style="margin-top:1.5rem;">
        <h3>Pacientes vinculados</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Paciente</th>
              <th>Meta di√°ria (kcal)</th>
              <th>Plano atual</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="pacientes-tbody">
            <tr>
              <td colspan="4">Carregando pacientes...</td>
            </tr>
          </tbody>

        </table>

      </section>

    </div>
  </main>

  <footer class="footer">
    <div class="container">¬© 2025 NutriMatch ‚Ä¢ Flexibilidade real no plano alimentar.</div>
  </footer>
  <!-- Carrega o script centralizado para listar pacientes dinamicamente -->
  <script src="js/app.js"></script>


  <script>
    async function carregarPacientes() {
      const tbody = document.getElementById('pacientes-tbody');
      tbody.innerHTML = '<tr><td colspan="4">Carregando pacientes...</td></tr>';

      try {
        const resp = await fetch('/api/pacientes');
        if (!resp.ok) throw new Error('Erro ao buscar pacientes');

        const data = await resp.json();
        
        const pacientes = Array.isArray(data) ? data : (data.pacientes || []);

        if (!pacientes.length) {
          tbody.innerHTML = '<tr><td colspan="4">Nenhum paciente vinculado.</td></tr>';
          return;
        }

        tbody.innerHTML = '';

        pacientes.forEach(p => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>
              ${p.nome}<br>
              <span class="small">${p.email}</span>
            </td>
            <td>${p.meta_kcal_diaria ?? '-'}</td>
            <td>-</td>
            <td>
              <a class="btn" href="gestao_paciente.html?paciente_id=${p.paciente_id}">
                Ver / editar
              </a>
              <button
                type="button"
                class="btn outline btn-desvincular"
                data-id="${p.paciente_id}"
              >
                Excluir v√≠nculo
              </button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        // Liga os cliques dos bot√µes "Excluir v√≠nculo"
        document.querySelectorAll('.btn-desvincular').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.getAttribute('data-id');

            if (!confirm('Deseja realmente excluir o v√≠nculo com este paciente?')) {
              return;
            }

            try {
              const resp = await fetch(`/api/pacientes/${id}/desvincular`, {
                method: 'POST'
              });

              if (!resp.ok) {
                const erro = await resp.json().catch(() => ({}));
                alert(erro.mensagem || 'Erro ao excluir v√≠nculo.');
                return;
              }

              // Recarrega a lista ap√≥s excluir
              await carregarPacientes();
            } catch (err) {
              console.error(err);
              alert('Erro de comunica√ß√£o com o servidor.');
            }
          });
        });

      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="4">Erro ao carregar pacientes.</td></tr>';
      }
    }

    document.addEventListener('DOMContentLoaded', carregarPacientes);
  </script>


</body>
</html>
