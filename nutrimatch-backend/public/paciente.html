<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch ‚Äî Paciente (Nutri)</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    .edit-mode .editable { display: none; }
    .edit-mode .edit-input { display: inline-block; }

    .meal-edit { margin-top: 1rem; }
    .meal-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.5rem; border: 1px solid #ddd; margin-bottom: 0.5rem;
      border-radius: 10px;
      background: #fff;
    }
    .meal-item button {
      background: #f44336; color: white; border: none;
      padding: 0.2rem 0.5rem; cursor: pointer; border-radius: 8px;
    }

    .input-container { position: relative; display: inline-block; width: 100%; }
    .suggestions {
      position: absolute; top: 100%; left: 0; right: 0;
      background: white; border: 1px solid #ccc; z-index: 1000;
      max-height: 150px; overflow-y: auto; border-radius: 10px;
    }
    .suggestion-item { padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee; }
    .suggestion-item:hover { background: #f0f0f0; }
  </style>
</head>

<body>
<header class="login-header">
  <div class="container">
    <nav>
      <a class="brand" href="dashboard_nutri.html">
        <img src="images/logo.png" alt="Logo NutriMatch">
      </a>
      <div class="nav-links">
        <a href="dashboard_nutri.html">Meus pacientes</a>
        <a href="perfil.html">üë§</a>
        <a href="/logout">Sair</a>
      </div>
    </nav>
  </div>
</header>

<main>
<div class="container">

  <div class="top-actions">
    <button type="button" class="btn outline btn-back" onclick="window.history.back()">‚Üê Voltar</button>
  </div>

  <div class="grid grid-2">
    <section class="card">
      <h2 id="titulo-plano">Plano alimentar</h2>

      <div class="kpis">
        <div class="kpi">
          <div>Meta di√°ria</div>
          <strong id="meta-diaria-display" class="editable">-</strong>
          <input id="meta-diaria-input" class="edit-input" type="number" style="display:none;" placeholder="kcal">
          <button id="salvar-meta" class="edit-input btn" style="display:none; margin-left:0.5rem;">Salvar</button>
        </div>

        <div class="kpi"><div>Consumido hoje</div><strong id="consumido-hoje">-</strong></div>
        <div class="kpi"><div>Restante</div><strong id="restante">-</strong></div>
      </div>

      <p class="small" id="plano-info">Carregando plano...</p>
    </section>

    <section class="card">
      <h2>Substitui√ß√µes de hoje</h2>
      <table class="table">
        <thead><tr><th>Refei√ß√£o</th><th>Original (meta)</th><th>Substitui√ß√£o</th><th>Conformidade</th></tr></thead>
        <tbody>
          <tr><td>Lanche tarde</td><td>Panqueca banana (170 kcal)</td><td>Mingau aveia (165 kcal)</td><td style="color:#6BC24A">Dentro (¬±10%)</td></tr>
          <tr><td>Almo√ßo</td><td>Frango + arroz (600 kcal)</td><td>Omelete + salada (520 kcal)</td><td style="color:#F45C2C">Fora</td></tr>
        </tbody>
      </table>
      <p class="small muted">Obs: essa tabela ainda est√° est√°tica no HTML.</p>
    </section>
  </div>

  <section class="card">
    <h2>Plano por refei√ß√£o</h2>

    <div class="tabs">
      <a class="tab active" href="#cafe">Caf√© da manh√£</a>
      <a class="tab" href="#lanche-manha">Lanche da manh√£</a>
      <a class="tab" href="#almoco">Almo√ßo</a>
      <a class="tab" href="#lanche-tarde">Lanche da tarde</a>
      <a class="tab" href="#jantar">Jantar</a>
      <a class="tab" href="#ceia">Ceia</a>
    </div>

    <div class="grid grid-3">
      <div class="meal" id="cafe"><h3>Caf√© da manh√£</h3><div class="meal-content"></div></div>
      <div class="meal" id="lanche-manha"><h3>Lanche da manh√£</h3><div class="meal-content"></div></div>
      <div class="meal" id="almoco"><h3>Almo√ßo</h3><div class="meal-content"></div></div>
      <div class="meal" id="lanche-tarde"><h3>Lanche da tarde</h3><div class="meal-content"></div></div>
      <div class="meal" id="jantar"><h3>Jantar</h3><div class="meal-content"></div></div>
      <div class="meal" id="ceia"><h3>Ceia (opcional)</h3><div class="meal-content"></div></div>
    </div>
  </section>

</div>
</main>

<footer class="footer"><div class="container">¬© 2025 NutriMatch ‚Ä¢ Flexibilidade real no plano alimentar.</div></footer>

<script src="js/app.js"></script>

<script>
  function getPacienteIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('paciente_id');
  }

  function isEditMode() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('edit') === 'true';
  }

  function wireAutocomplete() {
    const mealTypes = ['cafe', 'lanche-manha', 'almoco', 'lanche-tarde', 'jantar', 'ceia'];

    mealTypes.forEach(type => {
      const input = document.getElementById(`receita-${type}`);
      const suggestions = document.getElementById(`suggestions-${type}`);
      if (!input || !suggestions) return;

      if (input.dataset.wired === '1') return;
      input.dataset.wired = '1';

      input.addEventListener('input', () => buscarSugestoes(input, suggestions, type));
      input.addEventListener('blur', () => setTimeout(() => (suggestions.style.display = 'none'), 150));
    });
  }

  async function carregarDados() {
    const pacienteId = getPacienteIdFromUrl();
    const edit = isEditMode();

    if (!pacienteId) {
      alert('Paciente n√£o especificado.');
      window.history.back();
      return;
    }

    if (edit) document.body.classList.add('edit-mode');
    else document.body.classList.remove('edit-mode');

    try {
      // 1) Paciente
      const respPaciente = await fetch(`/api/pacientes/${pacienteId}`);
      if (!respPaciente.ok) {
        const erro = await respPaciente.json().catch(() => ({}));
        alert(erro.mensagem || 'Erro ao carregar paciente.');
        window.history.back();
        return;
      }
      const dataPaciente = await respPaciente.json();
      const paciente = dataPaciente.paciente || dataPaciente;

      document.getElementById('titulo-plano').textContent = `Plano alimentar ‚Äî ${paciente.nome || ''}`;

      // 2) Meta di√°ria
      const metaDisplay = document.getElementById('meta-diaria-display');
      const metaInput = document.getElementById('meta-diaria-input');
      const salvarMeta = document.getElementById('salvar-meta');

      metaDisplay.textContent = paciente.meta_kcal_diaria ? `${paciente.meta_kcal_diaria} kcal` : '-';

      if (edit) {
        metaInput.style.display = 'inline-block';
        salvarMeta.style.display = 'inline-block';
        metaInput.value = paciente.meta_kcal_diaria || '';

        salvarMeta.onclick = async () => {
          const newMeta = Number(metaInput.value);
          if (isNaN(newMeta) || newMeta <= 0) {
            alert('Meta inv√°lida.');
            return;
          }
          try {
            const resp = await fetch(`/api/pacientes/${pacienteId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ meta_kcal: newMeta })
            });

            if (resp.ok) {
              metaDisplay.textContent = `${newMeta} kcal`;
              alert('Meta atualizada!');
            } else {
              const data = await resp.json().catch(() => ({}));
              alert(data.mensagem || `Erro ao atualizar meta. Status ${resp.status}`);
            }
          } catch {
            alert('Erro de comunica√ß√£o.');
          }
        };
      } else {
        metaInput.style.display = 'none';
        salvarMeta.style.display = 'none';
      }

      // 3) PLANO ATUAL
      const respPlano = await fetch(`/api/plano-atual/${pacienteId}`);
      let plano = [];
      if (respPlano.ok) {
        plano = await respPlano.json();
      } else {
        plano = [];
      }

      // 4) consumido/restante (simulado)
      const consumido = 0;
      const meta = Number(paciente.meta_kcal_diaria || 0);
      const restante = meta - consumido;

      document.getElementById('consumido-hoje').textContent = `${consumido} kcal`;
      document.getElementById('restante').textContent = restante > 0 ? `${restante} kcal` : '0 kcal';

      document.getElementById('plano-info').textContent =
        `Plano atual ‚Ä¢ Refei√ß√µes cadastradas: ${plano.length}`;

      // 5) Renderizar por refei√ß√£o
      const mealTypes = ['cafe', 'lanche-manha', 'almoco', 'lanche-tarde', 'jantar', 'ceia'];

      mealTypes.forEach(type => {
        const container = document.querySelector(`#${type} .meal-content`);
        if (!container) return;

        const itens = plano.filter(p => p.refeicao === type);

        if (!edit) {
          container.innerHTML = itens.length
            ? itens.map(i => `<div class="recipe">${escapeHtml(i.receita_recomendada)} (${Number(i.kcal_meta)} kcal)</div>`).join('')
            : `<p class="small">Sem itens cadastrados.</p>`;
        } else {
          container.innerHTML = `
            <div class="meal-edit">
              <div class="input-container">
                <input id="receita-${type}" placeholder="Digite alimento/receita..." autocomplete="off">
                <div id="suggestions-${type}" class="suggestions" style="display:none;"></div>
              </div>

              <input id="kcal-${type}" type="number" placeholder="kcal (meta)" style="width:120px;">
              <button class="btn" type="button" onclick="adicionarRefeicao('${type}')">Adicionar</button>
            </div>

            <div style="margin-top:0.8rem;">
              ${itens.length
                ? itens.map(i => `
                    <div class="meal-item">
                      <span>${escapeHtml(i.receita_recomendada)} (${Number(i.kcal_meta)} kcal)</span>
                      <button type="button" onclick="removerRefeicao(${Number(i.id)})">X</button>
                    </div>
                  `).join('')
                : `<p class="small">Nenhuma refei√ß√£o cadastrada ainda.</p>`
              }
            </div>
          `;
        }
      });

      wireAutocomplete();

    } catch (err) {
      console.error(err);
      alert('Erro de comunica√ß√£o com o servidor.');
    }
  }

  function buscarSugestoes(input, suggestionsDiv, refeicao) {
    const query = input.value.trim();
    if (query.length < 2) {
      suggestionsDiv.style.display = 'none';
      return;
    }

    fetch(`/alimentos?q=${encodeURIComponent(query)}`)
      .then(resp => resp.json())
      .then(data => {
        suggestionsDiv.innerHTML = '';
        if (Array.isArray(data) && data.length > 0) {
          data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = `${item.nome} (${item.kcal_por_100g} kcal/100g)`;

            div.addEventListener('mousedown', (e) => {
              e.preventDefault();
              input.value = item.nome;
              const kcalInput = document.getElementById(`kcal-${refeicao}`);
              if (kcalInput) kcalInput.value = item.kcal_por_100g;
              suggestionsDiv.style.display = 'none';
            });

            suggestionsDiv.appendChild(div);
          });
          suggestionsDiv.style.display = 'block';
        } else {
          suggestionsDiv.style.display = 'none';
        }
      })
      .catch(err => {
        console.error(err);
        suggestionsDiv.style.display = 'none';
      });
  }

  // ADD no PLANO ATUAL (sem data no front)
  async function adicionarRefeicao(refeicao) {
    const receita = (document.getElementById(`receita-${refeicao}`)?.value || '').trim();
    const kcal = Number(document.getElementById(`kcal-${refeicao}`)?.value);

    if (!receita || isNaN(kcal) || kcal <= 0) {
      alert('Preencha receita e kcal v√°lidos.');
      return;
    }

    const pacienteId = getPacienteIdFromUrl();

    try {
      const resp = await fetch(`/api/plano-atual/${pacienteId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          refeicao,
          kcal_meta: kcal,
          receita_recomendada: receita
        })
      });

      if (resp.ok) {
        document.getElementById(`receita-${refeicao}`).value = '';
        document.getElementById(`kcal-${refeicao}`).value = '';
        await carregarDados();
      } else {
        const data = await resp.json().catch(() => ({}));
        alert(data.mensagem || `Erro ao adicionar refei√ß√£o. Status ${resp.status}`);
      }
    } catch (e) {
      console.error(e);
      alert('Erro de comunica√ß√£o.');
    }
  }

  async function removerRefeicao(id) {
    try {
      const resp = await fetch(`/api/plano/refeicao/${id}`, { method: 'DELETE' });
      if (resp.ok) {
        await carregarDados();
      } else {
        const data = await resp.json().catch(() => ({}));
        alert(data.mensagem || `Erro ao remover refei√ß√£o. Status ${resp.status}`);
      }
    } catch (e) {
      console.error(e);
      alert('Erro de comunica√ß√£o.');
    }
  }

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  document.addEventListener('DOMContentLoaded', carregarDados);
</script>

</body>
</html>
