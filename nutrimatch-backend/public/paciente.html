<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch ‚Äî Paciente (Nutri)</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    .edit-mode .editable { display: none; }
    .edit-mode .edit-input { display: inline-block; }
    .meal-edit { margin-top: 1rem; }
    .meal-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border: 1px solid #ddd; margin-bottom: 0.5rem; }
    .meal-item button { background: #f44336; color: white; border: none; padding: 0.2rem 0.5rem; cursor: pointer; }
  </style>
</head>
<body>
  <header class="login-header">
  <div class="container">
    <nav>
      <a class="brand" href="dashboard_nutri.html">
        <img src="images/logo.png" alt="Logo NutriMatch">
      </a>
      <div class="nav-links">
        <a href="dashboard_nutri.html">Meus pacientes</a>
        <a href="perfil.html">üë§</a>
        <!-- Sair via rota de logout -->
        <a href="/logout">Sair</a>
      </div>
    </nav>
  </div>
</header>
  <main>
  <div class="container">

    <div class="top-actions">
      <button
        type="button"
        class="btn outline btn-back"
        onclick="window.history.back()"
      >
        ‚Üê Voltar
      </button>
    </div>
  <div class="grid grid-2">
    <section class="card">
      <h2 id="titulo-plano">Plano alimentar</h2>
      <div class="kpis">
        <div class="kpi">
          <div>Meta di√°ria</div>
          <strong id="meta-diaria-display" class="editable">-</strong>
          <input id="meta-diaria-input" class="edit-input" type="number" style="display:none;" placeholder="kcal">
          <button id="salvar-meta" class="edit-input btn" style="display:none; margin-left:0.5rem;">Salvar</button>
        </div>
        <div class="kpi"><div>Consumido hoje</div><strong id="consumido-hoje">-</strong></div>
        <div class="kpi"><div>Restante</div><strong id="restante">-</strong></div>
      </div>
      <p class="small" id="plano-info">Carregando plano...</p>
    </section>
    <section class="card">
      <h2>Substitui√ß√µes de hoje</h2>
      <table class="table">
        <thead><tr><th>Refei√ß√£o</th><th>Original (meta)</th><th>Substitui√ß√£o</th><th>Conformidade</th></tr></thead>
        <tbody>
          <tr><td>Lanche tarde</td><td>Panqueca banana (170 kcal)</td><td>Mingau aveia (165 kcal)</td><td style="color:#6BC24A">Dentro (¬±10%)</td></tr>
          <tr><td>Almo√ßo</td><td>Frango + arroz (600 kcal)</td><td>Omelete + salada (520 kcal)</td><td style="color:#F45C2C">Fora</td></tr>
        </tbody>
      </table>
    </section>
  </div>
  <section class="card">
    <h2>Plano por refei√ß√£o</h2>
    <div class="tabs">
      <a class="tab active" href="#cafe">Caf√© da manh√£</a>
      <a class="tab" href="#lanche-manha">Lanche da manh√£</a>
      <a class="tab" href="#almoco">Almo√ßo</a>
      <a class="tab" href="#lanche-tarde">Lanche da tarde</a>
      <a class="tab" href="#jantar">Jantar</a>
      <a class="tab" href="#ceia">Ceia</a>
    </div>
    <div class="grid grid-3">
      <div class="meal" id="cafe"><h3>Caf√© da manh√£</h3><div class="meal-content"></div></div>
      <div class="meal" id="lanche-manha"><h3>Lanche da manh√£</h3><div class="meal-content"></div></div>
      <div class="meal" id="almoco"><h3>Almo√ßo</h3><div class="meal-content"></div></div>
      <div class="meal" id="lanche-tarde"><h3>Lanche da tarde</h3><div class="meal-content"></div></div>
      <div class="meal" id="jantar"><h3>Jantar</h3><div class="meal-content"></div></div>
      <div class="meal" id="ceia"><h3>Ceia (opcional)</h3><div class="meal-content"></div></div>
    </div>
  </section>
</div></main>
  <footer class="footer"><div class="container">¬© 2025 NutriMatch ‚Ä¢ Flexibilidade real no plano alimentar.</div></footer>
  <!-- Script centralizado para funcionalidades din√¢micas (futuro) -->
  <script src="js/app.js"></script>

  <script>
    async function carregarDados() {
      const urlParams = new URLSearchParams(window.location.search);
      const pacienteId = urlParams.get('paciente_id');
      const isEdit = urlParams.get('edit') === 'true';

      if (!pacienteId) {
        alert('Paciente n√£o especificado.');
        window.history.back();
        return;
      }

      if (isEdit) {
        document.body.classList.add('edit-mode');
      }

      try {
        // Carregar dados do paciente
        const respPaciente = await fetch(`/api/pacientes/${pacienteId}`);
        if (!respPaciente.ok) {
          const erro = await respPaciente.json().catch(() => ({}));
          alert(erro.mensagem || 'Erro ao carregar paciente.');
          window.history.back();
          return;
        }
        const dataPaciente = await respPaciente.json();
        const paciente = dataPaciente.paciente;

        // Atualizar t√≠tulo
        document.getElementById('titulo-plano').textContent = `Plano alimentar ‚Äî ${paciente.nome}`;

        // Meta di√°ria
        const metaDisplay = document.getElementById('meta-diaria-display');
        const metaInput = document.getElementById('meta-diaria-input');
        const salvarMeta = document.getElementById('salvar-meta');
        metaDisplay.textContent = paciente.meta_kcal_diaria ? `${paciente.meta_kcal_diaria} kcal` : '-';
        if (isEdit) {
          metaInput.value = paciente.meta_kcal_diaria || '';
          salvarMeta.onclick = async () => {
            const newMeta = Number(metaInput.value);
            if (isNaN(newMeta) || newMeta <= 0) {
              alert('Meta inv√°lida.');
              return;
            }
            try {
              const resp = await fetch(`/api/pacientes/${pacienteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ meta_kcal: newMeta })
              });
              if (resp.ok) {
                metaDisplay.textContent = `${newMeta} kcal`;
                alert('Meta atualizada!');
              } else {
                alert('Erro ao atualizar meta.');
              }
            } catch (e) {
              alert('Erro de comunica√ß√£o.');
            }
          };
        }

        // Carregar plano do dia (hoje)
        const hoje = new Date().toISOString().slice(0, 10);
        const respPlano = await fetch(`/api/plano?paciente_id=${pacienteId}&data=${hoje}`);
        let plano = [];
        if (respPlano.ok) {
          plano = await respPlano.json();
        }

        // Calcular consumido hoje (simulado)
        let consumido = 0;
        const restante = paciente.meta_kcal_diaria - consumido;

        document.getElementById('consumido-hoje').textContent = `${consumido} kcal`;
        document.getElementById('restante').textContent = restante > 0 ? `${restante} kcal` : '0 kcal';

        document.getElementById('plano-info').textContent = `Plano: Di√°rio ‚Ä¢ Refei√ß√µes: ${plano.length} cadastradas`;

        // Popular refei√ß√µes
        const mealTypes = ['cafe', 'lanche-manha', 'almoco', 'lanche-tarde', 'jantar', 'ceia'];
        mealTypes.forEach(type => {
          const content = document.querySelector(`#${type} .meal-content`);
          const mealsForType = plano.filter(m => m.refeicao === type);
          if (isEdit) {
            content.innerHTML = mealsForType.map(m => `
              <div class="meal-item">
                <span>${m.receita_recomendada} (${m.kcal_meta} kcal)</span>
                <button onclick="removerRefeicao(${m.id})">Remover</button>
              </div>
            `).join('') + `
              <div class="meal-edit">
                <input type="text" placeholder="Receita" id="receita-${type}">
                <input type="number" placeholder="kcal" id="kcal-${type}">
                <button onclick="adicionarRefeicao('${type}')">Adicionar</button>
              </div>
            `;
          } else {
            content.innerHTML = `<ul>${mealsForType.map(m => `<li>${m.receita_recomendada} (${m.kcal_meta} kcal)</li>`).join('')}</ul>`;
          }
        });

      } catch (err) {
        console.error(err);
        alert('Erro de comunica√ß√£o com o servidor.');
      }
    }

    async function adicionarRefeicao(refeicao) {
      const receita = document.getElementById(`receita-${refeicao}`).value.trim();
      const kcal = Number(document.getElementById(`kcal-${refeicao}`).value);
      if (!receita || isNaN(kcal) || kcal <= 0) {
        alert('Preencha receita e kcal v√°lidos.');
        return;
      }
      const urlParams = new URLSearchParams(window.location.search);
      const pacienteId = urlParams.get('paciente_id');
      const hoje = new Date().toISOString().slice(0, 10);
      try {
        const resp = await fetch('/api/plano/refeicao', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            paciente_id: pacienteId,
            data: hoje,
            refeicao,
            kcal_meta: kcal,
            receita_recomendada: receita
          })
        });
        if (resp.ok) {
          document.getElementById(`receita-${refeicao}`).value = '';
          document.getElementById(`kcal-${refeicao}`).value = '';
          carregarDados(); // Recarregar
        } else {
          alert('Erro ao adicionar refei√ß√£o.');
        }
      } catch (e) {
        alert('Erro de comunica√ß√£o.');
      }
    }

    async function removerRefeicao(id) {
      try {
        const resp = await fetch(`/api/plano/refeicao/${id}`, {
          method: 'DELETE'
        });
        if (resp.ok) {
          carregarDados(); // Recarregar
        } else {
          alert('Erro ao remover refei√ß√£o.');
        }
      } catch (e) {
        alert('Erro de comunica√ß√£o.');
      }
    }

    document.addEventListener('DOMContentLoaded', carregarDados);
  </script>

</body>
</html>