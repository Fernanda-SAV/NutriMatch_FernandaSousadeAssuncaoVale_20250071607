<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch — Gestão do Paciente</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    /* ===== BOTÕES DAS ABAS ===== */
    .aba-btn {
      padding: .55rem 1.1rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.6);
      /* fundo escuro semi-transparente pra destacar no card */
      background: rgba(0,0,0,0.35);
      color: #ffffff;
      transition: all .2s ease;
    }

    .aba-btn:hover {
      background: rgba(0,0,0,0.55);
      border-color: var(--accent-green);
    }

    /* Aba ativa bem destacada em verde */
    .aba-ativa {
      background: var(--accent-green) !important;
      border-color: var(--accent-green) !important;
      color: #ffffff !important;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
    }
  </style>
</head>

<body>

<header class="login-header">
  <div class="container">
    <nav>
      <a class="brand" href="dashboard_nutri.html">
        <img src="images/logo.png" alt="Logo NutriMatch">
        <strong>NutriMatch</strong>
      </a>
      <div class="nav-links">
        <a href="dashboard_nutri.html">Meus pacientes</a>
        <a href="gestao_paciente.html">Gestão do paciente</a>
        <a href="editar_pacientes.html">Editar pacientes</a>
        <!-- Sair via rota de logout para terminar sessão -->
        <a href="/logout">Sair</a>
      </div>
    </nav>
  </div>
</header>

<main>
  <div class="container">

    <div class="top-actions">
      <button
        type="button"
        class="btn outline btn-back"
        onclick="window.history.back()"
      >
        ← Voltar
      </button>
    </div>

    <!-- CABEÇALHO -->
    <section class="card">
      <h2 id="titulo-paciente">Gestão do paciente</h2>
      <p class="small">
        Use as abas abaixo para alternar entre dados do paciente, plano alimentar e diário alimentar.
        Apenas uma seção fica visível por vez.
      </p>

      <!-- ABAS -->
      <nav style="margin-top:1rem; display:flex; gap:.6rem; flex-wrap:wrap;">
        <button class="aba-btn" data-alvo="dados" type="button">Dados do paciente</button>
        <button class="aba-btn" data-alvo="plano" type="button">Plano alimentar</button>
        <button class="aba-btn" data-alvo="diario" type="button">Diário alimentar</button>
      </nav>
    </section>

    <!-- =============== SEÇÃO 1 — DADOS ================= -->
    <section class="card gestao-section" id="dados" style="margin-top:1.5rem;">
      <h3>Dados do paciente</h3>
      <p class="small">Informações básicas e medidas corporais.</p>

      <form class="form-vertical" id="form-dados" onsubmit="return false">
        <div class="campo">
          <label>Nome completo</label>
          <input id="nome" value="">
        </div>

        <div class="campo">
          <label>E-mail</label>
          <input id="email" type="email" value="">
        </div>

        <div class="campo">
          <label>Telefone</label>
          <input id="telefone" type="tel" value="">
        </div>

        <div class="campo">
          <label>Data de nascimento</label>
          <input id="nascimento" type="date" value="">
        </div>

        <div class="campo">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Selecione</option>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
            <option value="O">Outro</option>
          </select>
        </div>

        <div class="campo">
          <label>Peso (kg)</label>
          <input id="peso" type="number" step="0.1" value="">
        </div>

        <div class="campo">
          <label>Altura (cm)</label>
          <input id="altura" type="number" value="">
        </div>

        <div class="campo">
          <label>Meta calórica diária (kcal)</label>
          <input id="meta_kcal" type="number" min="800" max="6000" value="">
        </div>

        <div class="campo">
          <label>Observações clínicas</label>
          <textarea id="observacoes" rows="3"></textarea>
        </div>

        <button class="btn" type="submit">Salvar alterações</button>
      </form>
    </section>

    <!-- =============== SEÇÃO 2 — PLANO ================= -->
    <section class="card gestao-section" id="plano" style="margin-top:1.5rem; display:none;">
      <h3>Plano alimentar atual</h3>
      <p class="small">
        Visão geral das metas por refeição e das opções cadastradas pela nutricionista.
      </p>

      <table class="table">
        <thead>
          <tr>
            <th>Refeição</th>
            <th>Meta (kcal)</th>
            <th>Opções cadastradas</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Café da manhã</td>
            <td>350</td>
            <td>Iogurte + granola • Omelete • Vitamina de banana</td>
          </tr>
          <tr>
            <td>Lanche da manhã</td>
            <td>150</td>
            <td>Banana • Mix de castanhas • Biscoito água e sal</td>
          </tr>
          <tr>
            <td>Almoço</td>
            <td>600</td>
            <td>Frango + arroz • Carne moída + purê • Peixe + batata</td>
          </tr>
          <tr>
            <td>Lanche da tarde</td>
            <td>170</td>
            <td>Panqueca de banana • Mingau rápido • Maçã + amendoim</td>
          </tr>
          <tr>
            <td>Jantar</td>
            <td>500</td>
            <td>Frango grelhado + legumes • Macarrão integral • Omelete completa</td>
          </tr>
          <tr>
            <td>Ceia (opcional)</td>
            <td>120</td>
            <td>Leite morno • Iogurte natural • Chá + torradinha</td>
          </tr>
        </tbody>
      </table>

      <div class="actions" style="margin-top:.8rem;">
        <a class="btn" href="paciente.html">Editar plano alimentar</a>
      </div>
    </section>

    <!-- =============== SEÇÃO 3 — DIÁRIO ================= -->
    <section class="card gestao-section" id="diario" style="margin-top:1.5rem; display:none;">
      <h3>Diário alimentar</h3>
      <p class="small">
        Histórico das refeições que o paciente confirmou no aplicativo.
      </p>

      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Refeição</th>
            <th>Receita escolhida</th>
            <th>Origem</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>10/12/2025</td>
            <td>Café da manhã</td>
            <td>Vitamina de banana</td>
            <td>Plano</td>
          </tr>
          <tr>
            <td>10/12/2025</td>
            <td>Lanche da tarde</td>
            <td>Banana assada com aveia (IA)</td>
            <td>Substituição</td>
          </tr>
          <tr>
            <td>09/12/2025</td>
            <td>Almoço</td>
            <td>Frango + arroz + salada</td>
            <td>Plano</td>
          </tr>
        </tbody>
      </table>

      <p class="small" style="margin-top:.8rem;">
        Em uma versão completa, seria possível filtrar por período e exportar o diário.
      </p>
    </section>

  </div>
</main>

<footer class="footer">
  <div class="container">© 2025 NutriMatch • Flexibilidade real no plano alimentar.</div>
</footer>

<!-- SCRIPT: ABAS EXCLUSIVAS COM COR DINÂMICA -->
  <!-- Carrega funcionalidades dinâmicas (abas e outras ações) -->
  <script src="js/app.js"></script>

  <script>
    async function carregarPaciente() {
      const urlParams = new URLSearchParams(window.location.search);
      const pacienteId = urlParams.get('paciente_id');

      if (!pacienteId) {
        alert('Paciente não especificado.');
        window.history.back();
        return;
      }

      try {
        const resp = await fetch(`/api/pacientes/${pacienteId}`);
        if (!resp.ok) {
          const erro = await resp.json().catch(() => ({}));
          alert(erro.mensagem || 'Erro ao carregar paciente.');
          window.history.back();
          return;
        }

        const data = await resp.json();
        const paciente = data.paciente;

        // Preencher título
        document.getElementById('titulo-paciente').textContent = `Gestão do paciente — ${paciente.nome}`;

        // Preencher campos
        document.getElementById('nome').value = paciente.nome || '';
        document.getElementById('email').value = paciente.email || '';
        document.getElementById('telefone').value = paciente.telefone || '';
        document.getElementById('nascimento').value = paciente.nascimento || '';
        document.getElementById('sexo').value = paciente.sexo || '';
        document.getElementById('peso').value = paciente.peso || '';
        document.getElementById('altura').value = paciente.altura || '';
        document.getElementById('meta_kcal').value = paciente.meta_kcal_diaria || '';
        document.getElementById('observacoes').value = ''; // Não temos no banco ainda

      } catch (err) {
        console.error(err);
        alert('Erro de comunicação com o servidor.');
        window.history.back();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      carregarPaciente();

      // Form submit
      document.getElementById('form-dados').addEventListener('submit', async (e) => {
        e.preventDefault();

        const urlParams = new URLSearchParams(window.location.search);
        const pacienteId = urlParams.get('paciente_id');

        const dados = {
          nome: document.getElementById('nome').value,
          email: document.getElementById('email').value,
          telefone: document.getElementById('telefone').value,
          nascimento: document.getElementById('nascimento').value,
          sexo: document.getElementById('sexo').value,
          peso: document.getElementById('peso').value,
          altura: document.getElementById('altura').value,
          meta_kcal: document.getElementById('meta_kcal').value
        };

        try {
          const resp = await fetch(`/api/pacientes/${pacienteId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
          });

          if (!resp.ok) {
            const erro = await resp.json().catch(() => ({}));
            alert(erro.mensagem || 'Erro ao salvar.');
            return;
          }

          const data = await resp.json();
          alert(data.mensagem || 'Dados salvos com sucesso!');

        } catch (err) {
          console.error(err);
          alert('Erro de comunicação com o servidor.');
        }
      });
    });
  </script>

</body>
</html>
