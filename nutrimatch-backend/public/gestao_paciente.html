<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NutriMatch — Gestão do Paciente</title>
  <link rel="stylesheet" href="css/style.css">

  <style>
    /* ===== BOTÕES DAS ABAS ===== */
    .aba-btn {
      padding: .55rem 1.1rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.6);
      /* fundo escuro semi-transparente pra destacar no card */
      background: rgba(0,0,0,0.35);
      color: #ffffff;
      transition: all .2s ease;
    }

    .aba-btn:hover {
      background: rgba(0,0,0,0.55);
      border-color: var(--accent-green);
    }

    /* Aba ativa bem destacada em verde */
    .aba-ativa {
      background: var(--accent-green) !important;
      border-color: var(--accent-green) !important;
      color: #ffffff !important;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
    }
  </style>
</head>

<body>

<header class="login-header">
  <div class="container">
    <nav>
      <a class="brand" href="dashboard_nutri.html">
        <img src="images/logo.png" alt="Logo NutriMatch">
        <strong>NutriMatch</strong>
      </a>
      <div class="nav-links">
        <a href="dashboard_nutri.html">Meus pacientes</a>
        <a href="gestao_paciente.html">Gestão do paciente</a>
        <a href="editar_pacientes.html">Editar pacientes</a>
        <!-- Sair via rota de logout para terminar sessão -->
        <a href="/logout">Sair</a>
      </div>
    </nav>
  </div>
</header>

<main>
  <div class="container">

    <div class="top-actions">
      <button
        type="button"
        class="btn outline btn-back"
        onclick="window.history.back()"
      >
        ← Voltar
      </button>
    </div>

    <!-- CABEÇALHO -->
    <section class="card">
      <h2 id="titulo-paciente">Gestão do paciente</h2>
      <p class="small">
        Use as abas abaixo para alternar entre dados do paciente, plano alimentar e diário alimentar.
        Apenas uma seção fica visível por vez.
      </p>

      <!-- ABAS -->
      <nav style="margin-top:1rem; display:flex; gap:.6rem; flex-wrap:wrap;">
        <button class="aba-btn" data-alvo="dados" type="button">Dados do paciente</button>
        <button class="aba-btn" data-alvo="plano" type="button">Plano alimentar</button>
        <button class="aba-btn" data-alvo="diario" type="button">Diário alimentar</button>
      </nav>
    </section>

    <!-- =============== SEÇÃO 1 — DADOS ================= -->
    <section class="card gestao-section" id="dados" style="margin-top:1.5rem;">
      <h3>Dados do paciente</h3>
      <p class="small">Informações básicas e medidas corporais.</p>

      <form class="form-vertical" id="form-dados" onsubmit="return false">
        <div class="campo">
          <label>Nome completo</label>
          <input id="nome" readonly value="">
        </div>

        <div class="campo">
          <label>E-mail</label>
          <input id="email" type="email" readonly value="">
        </div>

        <div class="campo">
          <label>Telefone</label>
          <input id="telefone" type="tel" readonly value="">
        </div>

        <div class="campo">
          <label>Data de nascimento</label>
          <input id="nascimento" type="date" readonly value="">
        </div>

        <div class="campo">
          <label>Sexo</label>
          <select id="sexo" disabled>
            <option value="">Selecione</option>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
            <option value="O">Outro</option>
          </select>
        </div>

        <div class="campo">
          <label>Peso (kg)</label>
          <input id="peso" type="number" step="0.1" value="">
        </div>

        <div class="campo">
          <label>Altura (cm)</label>
          <input id="altura" type="number" readonly value="">
        </div>

        <div class="campo">
          <label>Meta calórica diária (kcal)</label>
          <input id="meta_kcal" type="number" min="800" max="6000" value="">
        </div>

        <div class="campo">
          <label>Observações clínicas</label>
          <textarea id="observacoes" rows="3"></textarea>
        </div>

        <button class="btn" type="submit">Salvar alterações</button>
      </form>
    </section>

    <!-- =============== SEÇÃO 2 — PLANO ================= -->
    <section class="card gestao-section" id="plano" style="margin-top:1.5rem; display:none;">
      <h3>Plano alimentar atual</h3>
      <p class="small">
        Visão geral das metas por refeição e das opções cadastradas pela nutricionista.
      </p>

      <div id="plano-content">
        <p>Carregando plano...</p>
      </div>

      <div class="actions" style="margin-top:.8rem;">
        <a id="link-plano" class="btn" href="#">Editar plano alimentar</a>
      </div>
    </section>

    <!-- =============== SEÇÃO 3 — DIÁRIO ================= -->
    <section class="card gestao-section" id="diario" style="margin-top:1.5rem; display:none;">
      <h3>Diário alimentar</h3>
      <p class="small">
        Histórico das refeições que o paciente confirmou no aplicativo.
      </p>

      <div id="diario-content">
        <p>Carregando diário...</p>
      </div>

      <p class="small" style="margin-top:.8rem;">
        Em uma versão completa, seria possível filtrar por período e exportar o diário.
      </p>
    </section>

  </div>
</main>

<footer class="footer">
  <div class="container">© 2025 NutriMatch • Flexibilidade real no plano alimentar.</div>
</footer>

<!-- SCRIPT: ABAS EXCLUSIVAS COM COR DINÂMICA -->
  <!-- Carrega funcionalidades dinâmicas (abas e outras ações) -->
  <script src="js/app.js"></script>

  <script>
    async function carregarPaciente() {
      const urlParams = new URLSearchParams(window.location.search);
      const pacienteId = urlParams.get('paciente_id');

      if (!pacienteId) {
        alert('Paciente não especificado.');
        window.history.back();
        return;
      }

      try {
        const resp = await fetch(`/api/pacientes/${pacienteId}`);
        if (!resp.ok) {
          const erro = await resp.json().catch(() => ({}));
          alert(erro.mensagem || 'Erro ao carregar paciente.');
          window.history.back();
          return;
        }

        const data = await resp.json();
        const paciente = data.paciente;

        // Preencher título
        document.getElementById('titulo-paciente').textContent = `Gestão do paciente — ${paciente.nome}`;

        // Definir link do plano
        const linkPlano = document.getElementById('link-plano');
        if (linkPlano) {
          linkPlano.href = `paciente.html?paciente_id=${pacienteId}`;
        }

        // Preencher campos
        document.getElementById('nome').value = paciente.nome || '';
        document.getElementById('email').value = paciente.email || '';
        document.getElementById('telefone').value = paciente.telefone || '';
        document.getElementById('nascimento').value = paciente.nascimento || '';
        document.getElementById('sexo').value = paciente.sexo || '';
        document.getElementById('peso').value = paciente.peso || '';
        document.getElementById('altura').value = paciente.altura || '';
        document.getElementById('meta_kcal').value = paciente.meta_kcal_diaria || '';
        document.getElementById('observacoes').value = ''; // Não temos no banco ainda

      } catch (err) {
        console.error(err);
        alert('Erro de comunicação com o servidor.');
        window.history.back();
      }
    }

    async function carregarPlano() {
      const urlParams = new URLSearchParams(window.location.search);
      const pacienteId = urlParams.get('paciente_id');
      const content = document.getElementById('plano-content');

      content.innerHTML = '<p>Carregando plano...</p>';

      try {
        const resp = await fetch(`/api/plano/${pacienteId}`);
        if (!resp.ok) {
          content.innerHTML = '<p>Erro ao carregar plano.</p>';
          return;
        }

        const planos = await resp.json();

        if (!planos.length) {
          content.innerHTML = '<p>Nenhum plano cadastrado ainda.</p>';
          return;
        }

        // Agrupar por data
        const grouped = {};
        planos.forEach(p => {
          if (!grouped[p.data]) grouped[p.data] = [];
          grouped[p.data].push(p);
        });

        let html = '';
        for (const data in grouped) {
          html += `<h4>Data: ${data}</h4><table class="table"><thead><tr><th>Refeição</th><th>Meta (kcal)</th><th>Receita Recomendada</th></tr></thead><tbody>`;
          grouped[data].forEach(p => {
            html += `<tr><td>${p.refeicao}</td><td>${p.kcal_meta}</td><td>${p.receita_recomendada}</td></tr>`;
          });
          html += '</tbody></table>';
        }

        content.innerHTML = html;

      } catch (err) {
        console.error(err);
        content.innerHTML = '<p>Erro de comunicação.</p>';
      }
    }

    async function carregarDiario() {
      const urlParams = new URLSearchParams(window.location.search);
      const pacienteId = urlParams.get('paciente_id');
      const content = document.getElementById('diario-content');

      content.innerHTML = '<p>Carregando diário...</p>';

      try {
        const resp = await fetch(`/api/diario/${pacienteId}`);
        if (!resp.ok) {
          content.innerHTML = '<p>Erro ao carregar diário.</p>';
          return;
        }

        const registros = await resp.json();

        if (!registros.length) {
          content.innerHTML = '<p>Nenhum registro no diário ainda.</p>';
          return;
        }

        let html = '<table class="table"><thead><tr><th>Data</th><th>Refeição</th><th>Receita</th><th>Kcal</th><th>Origem</th><th>Observação</th></tr></thead><tbody>';
        registros.forEach(r => {
          html += `<tr><td>${r.data}</td><td>${r.refeicao}</td><td>${r.receita_nome}</td><td>${r.kcal_consumidas}</td><td>${r.origem}</td><td>${r.observacao || '-'}</td></tr>`;
        });
        html += '</tbody></table>';

        content.innerHTML = html;

      } catch (err) {
        console.error(err);
        content.innerHTML = '<p>Erro de comunicação.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      carregarPaciente();

      // Abas
      document.querySelectorAll('.aba-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const alvo = e.target.getAttribute('data-alvo');

          // Esconder todas as seções
          document.querySelectorAll('.gestao-section').forEach(sec => sec.style.display = 'none');

          // Remover classe ativa
          document.querySelectorAll('.aba-btn').forEach(b => b.classList.remove('aba-ativa'));

          // Mostrar seção alvo
          document.getElementById(alvo).style.display = 'block';
          e.target.classList.add('aba-ativa');

          // Carregar conteúdo se necessário
          if (alvo === 'plano') {
            carregarPlano();
          } else if (alvo === 'diario') {
            carregarDiario();
          }
        });
      });

      // Form submit
      document.getElementById('form-dados').addEventListener('submit', async (e) => {
        e.preventDefault();

        const urlParams = new URLSearchParams(window.location.search);
        const pacienteId = urlParams.get('paciente_id');

        const dados = {
          peso: document.getElementById('peso').value,
          meta_kcal: document.getElementById('meta_kcal').value,
          observacoes: document.getElementById('observacoes').value
        };

        try {
          const resp = await fetch(`/api/pacientes/${pacienteId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
          });

          if (!resp.ok) {
            const erro = await resp.json().catch(() => ({}));
            alert(erro.mensagem || 'Erro ao salvar.');
            return;
          }

          const data = await resp.json();
          alert(data.mensagem || 'Dados salvos com sucesso!');

        } catch (err) {
          console.error(err);
          alert('Erro de comunicação com o servidor.');
        }
      });
    });
  </script>

</body>
</html>
